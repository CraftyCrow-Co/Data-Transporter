<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
/* ==================== VARIABLES ==================== */
:root {
  --blue: #1a73e8;
  --blue-light: #e8f0fe;
  --green: #1e8e3e;
  --red: #d93025;
  --gray: #dadce0;
  --text: #3c4043;
  --bg: #f8f9fa;
}

/* ==================== BASE STYLES ==================== */
* {
  box-sizing: border-box;
}

body {
  font-family: 'Roboto', sans-serif;
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-size: 13px;
  line-height: 1.4;
}

html, body, #app {
  height: 100%;
  margin: 0;
}

#app {
  display: flex;
  flex-direction: column;
}

.view {
  flex: 1;
  overflow-y: auto;
}

.hidden {
  display: none !important;
}

/* ==================== TABS ==================== */
.tabs {
  display: flex;
  background: #fff;
  border-bottom: 1px solid var(--gray);
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.tab {
  flex: 1;
  padding: 14px;
  text-align: center;
  cursor: pointer;
  color: #5f6368;
  font-weight: 500;
  transition: all 0.2s;
}

.tab.active {
  border-bottom: 2px solid var(--blue);
  color: var(--blue);
  font-weight: bold;
}

/* ==================== LAYOUT ==================== */
.container {
  padding: 12px;
  padding-bottom: 100px;
}

.card {
  background: #fff;
  border: 1px solid var(--gray);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  position: relative;
}

/* ==================== TYPOGRAPHY ==================== */
h3 {
  margin: 0 0 12px;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
  color: #202124;
}

label {
  display: block;
  margin-top: 12px;
  font-weight: 500;
  font-size: 12px;
  color: #5f6368;
}

/* ==================== FORM ELEMENTS ==================== */
select, input {
  width: 100%;
  padding: 8px;
  margin-top: 4px;
  border: 1px solid var(--gray);
  border-radius: 4px;
  font-size: 13px;
  outline-color: var(--blue);
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-size: 12px;
  color: var(--text);
  margin: 6px 0;
}

.checkbox-label input[type="checkbox"] {
  margin: 0;
  width: 16px;
  height: 16px;
}

.checkbox-help {
  font-size: 10px;
  color: #666;
  margin: 2px 0 6px 24px;
}

/* ==================== MODE GRID ==================== */
.mode-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-top: 10px;
}

.mode-item {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 6px;
  border: 1px solid var(--gray);
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  color: #3c4043;
  cursor: pointer;
  background: #fff;
  transition: all 0.2s ease;
}

.mode-item:hover {
  background: #f1f3f4;
}

.mode-item input[type="radio"] {
  margin: 0;
  accent-color: var(--blue);
}

.mode-item input[type="radio"]:checked + span {
  font-weight: 600;
}

.mode-item:has(input[type="radio"]:checked) {
  border-color: var(--blue);
  background: var(--blue-light);
}

/* ==================== BUTTONS ==================== */
.btn {
  flex: 1;
  padding: 10px;
  border-radius: 4px;
  border: none;
  font-weight: 500;
  cursor: pointer;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  transition: filter 0.2s;
}

.btn:active {
  filter: brightness(0.9);
}

.btn-run {
  background: var(--green);
  order: 1;
}

.btn-save {
  background: var(--blue);
  order: 2;
}

.btn-small {
  margin-top: 5px;
  padding: 4px 8px;
  font-size: 11px;
  cursor: pointer;
  background-color: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.btn-small:hover {
  background-color: #e0e0e0;
}

.tool-btn {
  width: 32px;
  height: 32px;
  border-radius: 6px;
  border: none;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.1s;
}

.tool-btn:hover {
  opacity: 0.9;
  transform: scale(1.05);
}

.tool-btn i {
  font-size: 18px;
}

.config-menu {
  position: absolute;
  right: 0;
  top: 100%;
  margin-top: 4px;
  background: white;
  border: 1px solid #dadce0;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  min-width: 160px;
  z-index: 1000;
}

.config-menu.hidden {
  display: none;
}

.menu-item {
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: background 0.2s;
  font-size: 13px;
  color: #202124;
}

.menu-item:hover {
  background: #f1f3f4;
}

.menu-item:first-child {
  border-radius: 8px 8px 0 0;
}

.menu-item:last-child {
  border-radius: 0 0 8px 8px;
}

.menu-item i {
  font-size: 18px;
  color: #5f6368;
}

.toggle-btn {
  border: 1px solid var(--gray);
  background: #fff;
  border-radius: 6px;
  height: 36px;
  width: 36px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toggle-btn:hover {
  background: #f1f3f4;
}

/* ==================== FOOTER ==================== */
.footer-container {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: #fff;
  border-top: 1px solid var(--gray);
  z-index: 1000;
}

.footer-buttons {
  display: flex;
  gap: 10px;
  padding: 12px;
}

/* ==================== STATUS MESSAGES ==================== */
#status-msg {
  margin: 0 12px 12px;
  padding: 10px;
  border-radius: 4px;
  display: none;
  text-align: center;
  font-weight: 500;
  font-size: 12px;
}

.status-loading {
  background: var(--blue-light);
  color: var(--blue);
  border: 1px solid var(--blue);
  animation: pulse 2s infinite;
}

.status-success {
  background: #e6f4ea;
  color: var(--green);
  border: 1px solid var(--green);
}

.status-error {
  background: #fce8e6;
  color: var(--red);
  border: 1px solid var(--red);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* ==================== STATUS PILLS ==================== */
.status-pill {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 12px;
  font-weight: bold;
  margin-top: 4px;
  display: inline-block;
}

.pill-active {
  background: #e6f4ea;
  color: #1e8e3e;
  border: 1px solid #34a853;
}

.pill-inactive {
  background: #f1f3f4;
  color: #5f6368;
  border: 1px solid var(--gray);
}

/* ==================== DAY SELECTOR ==================== */
.day-circle {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #f1f3f4;
  color: #3c4043;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 11px;
  font-weight: 500;
  user-select: none;
}

.day-circle.active-day {
  background: var(--blue);
  color: white;
}

/* ==================== SOURCE BLOCKS ==================== */
.source-block {
  border: 1px solid var(--gray);
  border-radius: 6px;
  padding: 12px;
  margin-top: 15px;
  background: #fff;
  position: relative;
}

/* ==================== CHIPS ==================== */
.chip-container, .column-chips-container {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 6px;
}

.chip {
  display: inline-flex;
  align-items: center;
  background: var(--blue);
  color: #fff;
  padding: 4px 10px;
  border-radius: 16px;
  font-size: 12px;
  font-weight: 500;
  cursor: default;
  transition: background 0.2s ease;
}

.chip:hover {
  background: var(--red);
}

.chip .remove {
  margin-left: 6px;
  font-weight: bold;
  cursor: pointer;
}

/* ==================== SEARCH & SELECT ==================== */
.ss-search-group {
  position: relative;
  width: 100%;
}

.ss-search-input {
  width: 100%;
  padding: 8px 10px;
  font-size: 13px;
  border: 1px solid var(--gray);
  border-radius: 6px 6px 0 0;
  outline: none;
  background: #fff;
  transition: border-color 0.15s ease, box-shadow 0.15s ease;
}

.ss-search-input::placeholder {
  color: #9aa0a6;
}

.ss-search-input:focus {
  border-color: var(--blue);
  box-shadow: 0 0 0 1px var(--blue);
}

.ss-search-group select {
  width: 100%;
  border: 1px solid var(--gray);
  border-top: none;
  border-radius: 0 0 6px 6px;
  font-size: 13px;
  padding: 6px;
  background: #fff;
  outline: none;
  cursor: pointer;
}

.ss-search-group select[size] {
  max-height: 220px;
  overflow-y: auto;
}

.ss-search-group option {
  padding: 6px 8px;
  cursor: pointer;
}

.ss-search-group option:hover {
  background-color: #f1f3f4;
}

.ss-search-group option:checked {
  background-color: var(--blue-light);
  color: #174ea6;
}

.ss-search-group select:disabled,
.ss-search-group input:disabled {
  background: #f1f3f4;
  cursor: not-allowed;
  opacity: 0.7;
}

/* ==================== MODAL ==================== */
#modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(32,33,36,0.6);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(2px);
}

#modal-overlay.hidden {
  display: none;
  visibility: hidden;
  pointer-events: none;
}

.modal-card {
  width: 88%;
  max-height: 85%;
  overflow-y: auto;
  background: white;
  border-radius: 12px;
  padding: 20px;
  position: relative;
  box-shadow: 0 12px 24px rgba(0,0,0,0.2);
}

/* ==================== LOADING OVERLAY ==================== */
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.8);
  z-index: 2000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.spinner {
  width: 36px;
  height: 36px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid var(--blue);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ==================== DETAILS/SUMMARY ==================== */
details {
  border: 1px solid #f1f3f4;
  border-radius: 4px;
  padding: 8px;
  margin-top: 10px;
}

summary {
  cursor: pointer;
  color: var(--blue);
  font-weight: 500;
  font-size: 12px;
  outline: none;
}

/* ==================== MATERIAL ICONS ==================== */
.material-icons {
  font-family: 'Material Icons' !important;
  font-weight: normal;
  font-style: normal;
  display: inline-block;
  line-height: 1;
  text-transform: none;
  letter-spacing: normal;
  white-space: nowrap;
  direction: ltr;
}

/* ==================== DISABLED STATES ==================== */
#dest-controls[style*="none"],
#dest-controls.disabled {
  opacity: 0.5;
  pointer-events: none;
}

/* ==================== ARCHIVE MODE ==================== */
.archive-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #f1f3f4;
  border: 1px solid var(--gray);
  border-radius: 6px;
  padding: 8px 12px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: background 0.2s;
}

.archive-toggle:hover {
  background: #e8eaed;
}

.archive-toggle label {
  font-size: 12px;
  font-weight: 500;
  color: #202124;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
}

.archive-toggle input[type="checkbox"] {
  width: 36px;
  height: 18px;
  appearance: none;
  background: #ccc;
  border-radius: 20px;
  position: relative;
  cursor: pointer;
  transition: background 0.3s;
}

.archive-toggle input:checked {
  background: var(--blue);
}

.archive-toggle input::after {
  content: "";
  width: 14px;
  height: 14px;
  background: white;
  position: absolute;
  top: 2px;
  left: 2px;
  border-radius: 50%;
  transition: transform 0.2s ease;
}

.archive-toggle input:checked::after {
  transform: translateX(18px);
}

.archive-destination-options {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

.archive-destination-options label {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px;
  border: 1px solid var(--gray);
  border-radius: 4px;
  cursor: pointer;
  font-size: 11px;
  transition: all 0.2s;
}

.archive-destination-options label:hover {
  background: #f1f3f4;
}

.archive-destination-options input[type="radio"] {
  margin: 0;
  accent-color: var(--blue);
}

.archive-destination-options input[type="radio"]:checked + span {
  font-weight: 600;
}

.folder-display {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px;
  background: var(--blue-light);
  border: 1px solid var(--blue);
  border-radius: 4px;
  margin-top: 6px;
  font-size: 12px;
  color: var(--blue);
}

.folder-display i {
  font-size: 16px;
}
  </style>
</head>

<body>
  <!-- LOADING OVERLAY -->
  <div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    <p style="margin-top:10px; font-weight:bold; color:var(--blue);">Processing...</p>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div id="t-new" class="tab active" onclick="switchTab('new')">New Config</div>
    <div id="t-saved" class="tab" onclick="switchTab('saved')">Saved Configs</div>
  </div>

  <div class="container">
    <!-- ================= NEW CONFIG VIEW ================= -->
    <div id="view-new" class="view">
      
      <!-- ARCHIVE TOGGLE -->
      <div class="archive-toggle" onclick="document.getElementById('archiveToggle').click()">
        <label>
          <i class="material-icons" style="font-size:18px;">archive</i>
          <span>Archive Mode</span>
        </label>
        <input type="checkbox" id="archiveToggle" onclick="event.stopPropagation(); toggleArchiveMode()">
      </div>

      <!-- MODE & OPTIONS -->
      <div class="card" id="mode-options-card">
        <h3><i class="material-icons">settings</i> Mode & Options</h3>
        <div class="mode-grid" id="mode-selection">
          <label class="mode-item">
            <input type="radio" name="mode" value="copy" checked onchange="handleUI()">
            <span>Copy</span>
          </label>
          <label class="mode-item">
            <input type="radio" name="mode" value="cut" onchange="handleUI()">
            <span>Cut</span>
          </label>
          <label class="mode-item" id="vstack-option">
            <input type="radio" name="mode" value="vstack" onchange="handleUI()">
            <span>Append & Combine</span>
          </label>
        </div>
        <details id="advanced-options">
          <summary>Advanced Options</summary>
          <label class="checkbox-label">
            <input type="checkbox" class="option-checkbox" onchange="handleOptionalCheckboxChange()" id="includeHeaders">
            Include Headers
          </label>
          <label class="checkbox-label">
            <input type="checkbox" class="option-checkbox" onchange="handleOptionalCheckboxChange()" id="chkTimestamp">
            Add Auto-Timestamp
          </label>
          <label class="checkbox-label">
            <input type="checkbox" class="option-checkbox" onchange="handleOptionalCheckboxChange()" id="includeFormulas">
            Formulas
          </label>
          <label class="checkbox-label">
            <input type="checkbox" class="option-checkbox" onchange="handleOptionalCheckboxChange()" id="includeFormatting">
            Formatting
          </label>
          <label class="checkbox-label">
            <input type="checkbox" class="option-checkbox" onchange="handleOptionalCheckboxChange()" id="includeHeaderFormats">
            Headers
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="includeTableFormats" onchange="toggleTableStyle()">
            Table
          </label>
          <label class="checkbox-label">
            <input type="checkbox" class="option-checkbox cf-checkbox" id="includeCondFormats">
            Conditional Formatting
          </label>
          <div class="checkbox-help">Only enables when Table checkbox is checked</div>

          <div id="execution-options">
            <label>Data Mode</label>
            <select id="dataMode">
              <option value="replace">Replace</option>
              <option value="append">Append</option>
            </select>
            <label>Execution Type</label>
            <div style="display:flex; gap:10px;">
              <label><input type="radio" name="exec" value="std" checked onchange="handleUI()"> All</label>
              <label><input type="radio" name="exec" value="row" onchange="handleUI()"> Row</label>
              <label><input type="radio" name="exec" value="batch" onchange="handleUI()"> Batch</label>
            </div>
            <div id="batch-wrap" class="hidden">
              <label>Batch Size</label>
              <input type="number" id="batchSize" value="100">
            </div>
          </div>
        </details>
      </div>

      <!-- SOURCE -->
      <div class="card">
        <h3><i class="material-icons">upload_file</i> Source</h3>
        
        <!-- ARCHIVE SOURCE (Hidden by default) -->
        <div id="archive-source" class="hidden">
          <label>What to Archive</label>
          <select id="archiveSourceType" onchange="handleArchiveSourceType()">
            <option value="file">Entire Spreadsheet File</option>
            <option value="sheet">Specific Sheets</option>
          </select>

          <label>Source Spreadsheet</label>
          <div style="display: flex; gap: 4px; align-items: flex-start; margin-top: 4px;">
            <div style="flex: 1;" class="ss-input-container">
              <div class="ss-search-group">
                <input type="text" class="ss-search-input" placeholder="üîç Search..." onkeyup="filterDropdown(this)">
                <select id="archiveSourceFile" class="ss-select" onchange="loadArchiveSheets()">
                  <option value="" disabled selected>Select Spreadsheet...</option>
                </select>
              </div>
              <input type="text" id="archiveSourceFile-manual" class="ss-manual-id hidden" placeholder="Paste Spreadsheet URL or ID" onchange="loadArchiveSheets()">
            </div>
            <button type="button" class="toggle-btn" onclick="toggleInputMode(this)">
              <i class="material-icons" style="font-size:20px; color:#5f6368;">link</i>
            </button>
          </div>

          <div id="archive-sheet-picker" class="hidden" style="margin-top:12px;">
            <label>Select Sheets to Archive</label>
            <select id="archiveSheets" multiple size="6" style="height:120px;" onchange="updateArchiveNamePreview()">
              <option disabled>Load spreadsheet first...</option>
            </select>
            <div style="font-size:10px; color:#666; margin-top:4px;">
              Hold Ctrl/Cmd to select multiple sheets
            </div>
          </div>
          
          <label class="checkbox-label" style="margin-top:12px;">
            <input type="checkbox" id="archiveCleanup">
            <span>Remove blank rows/columns</span>
          </label>
        </div>

        <!-- TRANSFER SOURCE (Default) -->
        <div id="transfer-source">
          <div id="source-list"></div>
          <button id="add-vstack-btn" class="btn hidden" style="background:none; color:var(--blue); border:1px dashed var(--blue); width:100%; margin-top:10px;" onclick="addVstackSource()">
            + Add Source
          </button>
        </div>
      </div>

      <!-- DESTINATION -->
      <div class="card">
        <h3><i class="material-icons">download</i> Destination</h3>

        <!-- ARCHIVE DESTINATION -->
        <div id="archive-destination" class="hidden">
          <label>Archive Destination</label>
          <div class="archive-destination-options">
            <label>
              <input type="radio" name="archiveDest" value="root" checked onchange="handleArchiveDestChange()">
              <span>Don't Put in Folder</span>
            </label>
            <label>
              <input type="radio" name="archiveDest" value="select" onchange="handleArchiveDestChange()">
              <span>Select Drive Folder</span>
            </label>
            <label>
              <input type="radio" name="archiveDest" value="paste" onchange="handleArchiveDestChange()">
              <span>Paste Folder Link</span>
            </label>
          </div>

          <div id="archive-folder-select" class="hidden" style="margin-top:8px;">
            <button type="button" class="btn" style="background:#607d8b; width:100%;" onclick="openFolderPicker()">
              <i class="material-icons">folder_open</i>
              Browse Folders
            </button>
            <div style="margin-top:8px;">
              <label style="display:block; margin-bottom:4px; font-size:12px; color:#5f6368;">Selected Folder:</label>
              <input type="text" id="selected-folder-name" readonly placeholder="No folder selected" 
                     style="width:100%; padding:8px; background:#e8f0fe; border:1px solid #1a73e8; border-radius:4px; cursor:default; color:#1a73e8; font-weight:500;">
            </div>
          </div>

          <div id="archive-folder-paste" class="hidden" style="margin-top:8px;">
            <input type="text" id="archiveFolderPaste" placeholder="Paste folder URL or ID...">
          </div>

          <label style="margin-top:12px;">Archive File Name</label>
          <input type="text" id="archiveFileName" placeholder="Auto-generated name will appear here" oninput="updateArchiveNamePreview()">
          <div id="archive-name-preview" style="font-size:10px; color:#666; margin-top:4px; font-style:italic;">
            Preview: <span id="preview-name">Select a spreadsheet first</span>
          </div>
        </div>

        <!-- TRANSFER DESTINATION -->
        <!-- TRANSFER DESTINATION -->
        <div id="transfer-destination">
          <label>Destination Spreadsheet</label>
          <div style="display:flex; gap:4px; align-items:flex-start;">
            <div style="flex:1;" class="ss-input-container">
              <div class="ss-search-group">
                <input type="text" class="ss-search-input" id="dest-search" placeholder="üîç Search..." onkeyup="filterDropdown(this)">
                <select id="destSS" class="ss-select" data-placeholder="Select Destination Spreadsheet" onchange="fetchSheets(this)">
                  <option value="" selected disabled>Select Destination Spreadsheet</option>
                </select>
              </div>
              <input type="text" id="destSS-manual" class="ss-manual-id hidden" placeholder="Paste Spreadsheet URL or ID" onchange="fetchSheets(this)">
            </div>
            <button type="button" class="toggle-btn" onclick="toggleInputMode(this)">
              <i class="material-icons" style="font-size:20px; color:#5f6368;">link</i>
            </button>
          </div>

          <div id="dest-controls">
            <label>Sheet</label>
            <select id="destSheet"></select>
            <label>Start Cell</label>
            <input type="text" id="destStart" value="A1">
          </div>
        </div>
      </div>

      <!-- FILTERS -->
      <div class="card" id="filters-card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3><i class="material-icons">filter_alt</i> Filters</h3>
          <i class="material-icons" style="color:var(--blue); cursor:pointer;" onclick="addFilterRow()">add_circle</i>
        </div>
        <div id="filter-rows"></div>
      </div>

      <!-- ARCHIVE FILTERS -->
      <div class="card hidden" id="archive-filters-card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3><i class="material-icons">filter_alt</i> Archive Filters</h3>
          <i class="material-icons" style="color:var(--blue); cursor:pointer;" onclick="addArchiveFilterRow()">add_circle</i>
        </div>
        <div style="font-size:11px; color:#666; margin-bottom:8px;">
          Filter data before archiving (only matching rows will be kept)
        </div>
        <div id="archive-filter-rows"></div>
      </div>

      <!-- FOOTER BUTTONS -->
      <div class="footer-buttons" id="main-footer-actions" style="margin-top:20px;">
        <div id="new-actions-group" style="display:flex; gap:10px;">
          <button class="btn btn-run" style="flex:1;" onclick="runMigrationUI()">
            <i class="material-icons">play_arrow</i> Run Once
          </button>
          <button class="btn btn-save" style="flex:1;" onclick="saveConfigs()">
            <i class="material-icons">save</i> Save Config
          </button>
        </div>
      </div>
    </div>

    <!-- ================= SAVED CONFIGS VIEW ================= -->
    <div id="view-saved" class="view hidden">
      <div style="padding:10px; border-bottom:1px solid #eee;">
        <select id="filterSchedule" onchange="loadSaved()">
          <option value="all">All Configs</option>
          <option value="scheduled">Active Scheduled</option>
          <option value="not-scheduled">Not Scheduled</option>
        </select>
      </div>

      <label class="checkbox-label" style="margin-top:5px; background:var(--blue-light); padding:8px; border-radius:4px; border:1px solid #d2e3fc;">
        <input type="checkbox" id="filterCurrentSheet" onchange="loadSaved()">
        <span style="font-weight:500; color:var(--blue);">Show only transfers for this sheet</span>
      </label>

      <label class="checkbox-label" style="margin-top:5px; background:#e8f5e9; padding:8px; border-radius:4px; border:1px solid #81c784;">
        <input type="checkbox" id="filterArchiveOnly" onchange="loadSaved()">
        <span style="font-weight:500; color:#2e7d32;">üóÑÔ∏è Show only Archives</span>
      </label>

      <div id="saved-list">
        <p style="color:#333; font-style:italic; padding:8px;">No saved configs found.</p>
      </div>
    </div>
  </div>

  <!-- GLOBAL FOOTER -->
  <div class="footer-container">
    <div id="status-msg"></div>
  </div>

  <!-- MODAL -->
  <div id="modal-overlay" class="hidden" onclick="if(event.target===this)closeModal()">
    <div class="modal-card" onclick="event.stopPropagation()">
      <div id="modal-content"></div>
    </div>
  </div>

  <script>
// ==================== GLOBAL STATE ====================
let editingIndex = null;
let currentEditingName = "";
let ssCache = [];
let headerList = [];
let statusTimer = null;

let ACTIVE_CONTEXT = {
  spreadsheetId: '',
  spreadsheetName: ''
};

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {
  initLoad();
  loadSaved();
  toggleTableStyle();

  const headerFmt = document.getElementById('includeHeaderFormats');
  if (headerFmt) {
    headerFmt.addEventListener('change', function() {
      if (this.checked) {
        document.getElementById('includeHeaders').checked = true;
      }
    });
  }

  google.script.run
    .withSuccessHandler(ctx => { ACTIVE_CONTEXT = ctx; })
    .getActiveSheetContext();
  
  // Close dropdown menus when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.tool-btn-row')) {
      document.querySelectorAll('.config-menu').forEach(m => {
        m.classList.add('hidden');
      });
    }
  });
});

// ==================== ARCHIVE MODE ====================
function toggleArchiveMode() {
  const isArchive = document.getElementById('archiveToggle').checked;
  
  // Toggle visibility
  document.getElementById('archive-source').classList.toggle('hidden', !isArchive);
  document.getElementById('transfer-source').classList.toggle('hidden', isArchive);
  document.getElementById('archive-destination').classList.toggle('hidden', !isArchive);
  document.getElementById('transfer-destination').classList.toggle('hidden', isArchive);
  
  // Toggle filter cards
  document.getElementById('filters-card').classList.toggle('hidden', isArchive);
  document.getElementById('archive-filters-card').classList.toggle('hidden', !isArchive);
  
  // Hide/show specific elements
  const advancedOptions = document.getElementById('advanced-options');
  const vstackOption = document.getElementById('vstack-option');
  
  if (advancedOptions) advancedOptions.style.display = isArchive ? 'none' : 'block';
  if (vstackOption) vstackOption.style.display = isArchive ? 'none' : 'flex';
  
  // Load spreadsheets for archive if enabled
  if (isArchive) {
    loadArchiveSpreadsheets();
    updateArchiveNamePreview();
  }
}

function loadArchiveSpreadsheets() {
  const select = document.getElementById('archiveSourceFile');
  if (!select) return;
  
  select.innerHTML = '<option disabled selected>Loading...</option>';
  
  if (ssCache && ssCache.length > 0) {
    let html = '<option value="" disabled selected>Select Spreadsheet...</option>';
    ssCache.forEach(f => {
      html += `<option value="${f.id}">${f.name}</option>`;
    });
    select.innerHTML = html;
  }
}

function handleArchiveSourceType() {
  const type = document.getElementById('archiveSourceType').value;
  const sheetPicker = document.getElementById('archive-sheet-picker');
  
  if (sheetPicker) {
    sheetPicker.classList.toggle('hidden', type === 'file');
  }
  
  updateArchiveNamePreview();
}

function loadArchiveSheets() {
  // Determine which input mode is active
  const manualInput = document.getElementById('archiveSourceFile-manual');
  const dropdown = document.getElementById('archiveSourceFile');
  
  let fileId = '';
  if (manualInput && !manualInput.classList.contains('hidden') && manualInput.value) {
    fileId = manualInput.value.trim();
    // Extract ID from URL if needed
    if (fileId.includes('/d/')) {
      fileId = fileId.split('/d/')[1].split('/')[0];
    }
  } else {
    fileId = dropdown.value;
  }
  
  const sheetSelect = document.getElementById('archiveSheets');
  
  if (!fileId || !sheetSelect) return;
  
  sheetSelect.innerHTML = '<option disabled>Loading sheets...</option>';
  
  google.script.run
    .withSuccessHandler(sheets => {
      sheetSelect.innerHTML = '';
      sheets.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        sheetSelect.appendChild(opt);
      });
      updateArchiveNamePreview();
      
      // Update archive filter sheet dropdowns
      updateArchiveFilterSheetOptions(sheets);
    })
    .withFailureHandler(err => {
      sheetSelect.innerHTML = '<option disabled>Error loading sheets</option>';
      console.error(err);
    })
    .getSheetsInSpreadsheet(fileId);
}

function updateArchiveNamePreview() {
  const customName = document.getElementById('archiveFileName')?.value;
  const previewSpan = document.getElementById('preview-name');
  const fileNameInput = document.getElementById('archiveFileName');
  
  if (!previewSpan) return;
  
  // Get source info
  const manualInput = document.getElementById('archiveSourceFile-manual');
  const dropdown = document.getElementById('archiveSourceFile');
  const sourceType = document.getElementById('archiveSourceType')?.value;
  
  let sourceName = '';
  
  if (manualInput && !manualInput.classList.contains('hidden') && manualInput.value) {
    sourceName = manualInput.dataset.ssName || 'Spreadsheet';
  } else if (dropdown && dropdown.selectedOptions[0] && dropdown.value) {
    sourceName = dropdown.selectedOptions[0].text;
  }
  
  if (!sourceName || sourceName === 'Select Spreadsheet...') {
    previewSpan.textContent = 'Select a spreadsheet first';
    fileNameInput.placeholder = 'Auto-generated name will appear here';
    return;
  }
  
  // Build preview based on source type
  const now = new Date();
  const timestamp = formatDateForArchive(now);
  
  let previewName = '';
  
  // If custom name is entered, append suffix to it
  if (customName && customName.trim()) {
    previewName = customName.trim() + '_Archived_' + timestamp;
  } else {
    // Auto-generate based on source type
    if (sourceType === 'sheet') {
      const sheetSelect = document.getElementById('archiveSheets');
      const selectedSheets = sheetSelect ? Array.from(sheetSelect.selectedOptions).map(opt => opt.value) : [];
      
      if (selectedSheets.length === 0) {
        previewName = `${sourceName}_Archived_${timestamp}`;
      } else if (selectedSheets.length === 1) {
        previewName = `${sourceName} (${selectedSheets[0]})_Archived_${timestamp}`;
      } else {
        const sheetNames = selectedSheets.join(', ');
        previewName = `${sourceName} (${sheetNames})_Archived_${timestamp}`;
      }
    } else {
      previewName = `${sourceName}_Archived_${timestamp}`;
    }
  }
  
  // Always show the preview with suffix
  previewSpan.textContent = previewName;
  
  // Update placeholder to show what will be auto-generated if field is empty
  if (!customName || !customName.trim()) {
    fileNameInput.placeholder = previewName;
  } else {
    // Show that custom name will get suffix
    fileNameInput.placeholder = `Will be saved as: ${previewName}`;
  }
}

function formatDateForArchive(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function handleArchiveDestChange() {
  const mode = document.querySelector('input[name="archiveDest"]:checked').value;
  const folderSelect = document.getElementById('archive-folder-select');
  const folderPaste = document.getElementById('archive-folder-paste');
  
  if (folderSelect) folderSelect.classList.toggle('hidden', mode !== 'select');
  if (folderPaste) folderPaste.classList.toggle('hidden', mode !== 'paste');
}

function openFolderPicker() {
  console.log('Opening folder picker...');
  
  // Store the current timestamp before opening
  let lastTimestamp = '';
  
  google.script.run
    .withSuccessHandler(function(folderData) {
      if (folderData && folderData.timestamp) {
        lastTimestamp = folderData.timestamp;
      }
      console.log('Folder picker will open. Last timestamp:', lastTimestamp);
    })
    .getSelectedArchiveFolder();
  
  // Small delay then open picker
  setTimeout(function() {
    google.script.run.showFolderPicker();
    
    // Start checking for changes
    checkForSelectedFolder(lastTimestamp);
  }, 500);
}

function checkForSelectedFolder(lastTimestamp) {
  const maxAttempts = 15; // Check for 15 seconds
  let attempts = 0;
  
  console.log('Starting to check for folder selection. Last timestamp:', lastTimestamp);
  
  const intervalId = setInterval(function() {
    attempts++;
    
    google.script.run
      .withSuccessHandler(function(folderData) {
        console.log('Check attempt', attempts, 'Folder data:', folderData);
        
        if (folderData && folderData.id && folderData.name && folderData.timestamp !== lastTimestamp) {
          console.log('NEW folder selected:', folderData.name);
          clearInterval(intervalId);
          applySelectedFolder(folderData.id, folderData.name);
        } else if (attempts >= maxAttempts) {
          console.log('Stopped checking for folder selection after', attempts, 'attempts');
          clearInterval(intervalId);
        }
      })
      .withFailureHandler(function(err) {
        console.error('Error checking folder:', err);
        clearInterval(intervalId);
      })
      .getSelectedArchiveFolder();
  }, 1000); // Check every second
}

function applySelectedFolder(id, name) {
  console.log('applySelectedFolder called with:', { id, name });
  
  const folderNameInput = document.getElementById('selected-folder-name');
  const folderSelectDiv = document.getElementById('archive-folder-select');
  
  if (!folderNameInput) {
    console.error('selected-folder-name input not found!');
    alert('Error: Folder textbox not found. Please refresh the page.');
    return;
  }
  
  if (!folderSelectDiv) {
    console.error('archive-folder-select div not found!');
    return;
  }
  
  // Set the folder name with icon
  folderNameInput.value = 'üìÅ ' + name;
  folderNameInput.style.background = '#e8f0fe';
  folderNameInput.style.border = '1px solid #1a73e8';
  folderNameInput.style.color = '#1a73e8';
  
  // Store folder ID and name in dataset
  folderSelectDiv.dataset.folderId = id;
  folderSelectDiv.dataset.folderName = name;
  
  console.log('Folder selection complete:', {
    folderId: folderSelectDiv.dataset.folderId,
    folderName: folderSelectDiv.dataset.folderName,
    displayedValue: folderNameInput.value
  });
  
  // Show success feedback
  const originalValue = folderNameInput.value;
  folderNameInput.value = '‚úì ' + name;
  setTimeout(() => {
    folderNameInput.value = originalValue;
  }, 1000);
}

// ==================== ARCHIVE FILTERS ====================
function addArchiveFilterRow() {
  const container = document.getElementById('archive-filter-rows');
  if (!container) return;

  const div = document.createElement('div');
  div.className = 'filter-row-item';
  div.style = "display:flex; gap:5px; margin-top:8px; align-items:center; background:#f1f3f4; padding:5px; border-radius:4px;";
  
  div.innerHTML = `
    <select class="af-sheet" style="flex:1;" onchange="loadArchiveFilterColumns(this)">
      <option value="">Select Sheet</option>
    </select>
    <select class="af-col" style="flex:1;" disabled>
      <option value="">Select Column</option>
    </select>
    <select class="af-cond" style="flex:1;" onchange="toggleFilterValueInput(this)">
      <optgroup label="Text">
        <option value="equals">Equals</option>
        <option value="contains">Contains</option>
      </optgroup>
      <optgroup label="Number">
        <option value="greater_than">Greater Than</option>
        <option value="less_than">Less Than</option>
      </optgroup>
      <optgroup label="Logic">
        <option value="is_empty">Is Empty</option>
        <option value="is_not_empty">Is Not Empty</option>
      </optgroup>
      <optgroup label="Dates">
        <option value="today">Today</option>
        <option value="yesterday">Yesterday</option>
        <option value="last_n_days">Last N Days</option>
        <option value="next_n_days">Next N Days</option>
      </optgroup>
    </select>
    <input type="text" class="af-val" placeholder="Value" style="flex:0.8;">
    <i class="material-icons" style="color:var(--red); cursor:pointer; font-size:18px;" onclick="this.parentElement.remove()">remove_circle</i>
  `;
  
  container.appendChild(div);
  
  // Populate sheet dropdown
  const sheetSelect = document.getElementById('archiveSheets');
  const sheetDropdown = div.querySelector('.af-sheet');
  
  if (sheetSelect && sheetSelect.options.length > 0) {
    Array.from(sheetSelect.options).forEach(opt => {
      if (!opt.disabled && opt.value) {
        const newOpt = document.createElement('option');
        newOpt.value = opt.value;
        newOpt.textContent = opt.text;
        sheetDropdown.appendChild(newOpt);
      }
    });
  }
}

function loadArchiveFilterColumns(selectElement) {
  const sheetName = selectElement.value;
  const row = selectElement.closest('.filter-row-item');
  const colSelect = row.querySelector('.af-col');
  
  if (!sheetName) {
    colSelect.disabled = true;
    colSelect.innerHTML = '<option value="">Select Column</option>';
    return;
  }
  
  // Get source spreadsheet ID
  const manualInput = document.getElementById('archiveSourceFile-manual');
  const dropdown = document.getElementById('archiveSourceFile');
  
  let fileId = '';
  if (manualInput && !manualInput.classList.contains('hidden') && manualInput.value) {
    fileId = manualInput.value.trim();
    if (fileId.includes('/d/')) {
      fileId = fileId.split('/d/')[1].split('/')[0];
    }
  } else {
    fileId = dropdown.value;
  }
  
  if (!fileId) {
    colSelect.disabled = true;
    return;
  }
  
  colSelect.innerHTML = '<option value="">Loading...</option>';
  colSelect.disabled = true;
  
  google.script.run
    .withSuccessHandler(columns => {
      colSelect.innerHTML = '<option value="">Select Column</option>';
      columns.forEach(col => {
        const opt = document.createElement('option');
        opt.value = col;
        opt.textContent = col;
        colSelect.appendChild(opt);
      });
      colSelect.disabled = false;
    })
    .withFailureHandler(err => {
      colSelect.innerHTML = '<option value="">Error loading columns</option>';
      console.error(err);
    })
    .getArchiveSheetColumns(fileId, sheetName);
}

function updateArchiveFilterSheetOptions(sheets) {
  const filterRows = document.querySelectorAll('#archive-filter-rows .filter-row-item');
  
  filterRows.forEach(row => {
    const sheetSelect = row.querySelector('.af-sheet');
    if (!sheetSelect) return;
    
    const currentValue = sheetSelect.value;
    sheetSelect.innerHTML = '<option value="">Select Sheet</option>';
    
    sheets.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s;
      opt.textContent = s;
      sheetSelect.appendChild(opt);
    });
    
    if (sheets.includes(currentValue)) {
      sheetSelect.value = currentValue;
    }
  });
}

// ==================== EVENT HANDLERS ====================
document.addEventListener('change', function(e) {
  const select = e.target.closest('.ss-select');
  if (!select) return;

  select.size = 1;
  const searchInput = select.closest('.ss-search-group')?.querySelector('.ss-search-input');
  if (searchInput) searchInput.value = '';
});

document.querySelectorAll('.ss-search-input').forEach(input => {
  input.addEventListener('focus', () => {
    const select = input.closest('.ss-search-group')?.querySelector('select');
    if (select) select.size = 6;
  });
});

// ==================== UI HELPERS ====================
function getOptionalCheckboxes() {
  return ['includeHeaders', 'chkTimestamp', 'includeFormatting', 'includeHeaderFormats', 'includeFormulas']
    .map(id => document.getElementById(id))
    .filter(Boolean);
}

function toggleTableStyle() {
  const tableStyle = document.getElementById("includeTableFormats").checked;
  const condFormat = document.getElementById("includeCondFormats");
  const execBlock = document.getElementById("execution-options");
  const optionalCheckboxes = getOptionalCheckboxes();

  optionalCheckboxes.forEach(cb => {
    cb.disabled = tableStyle;
    if (tableStyle) cb.checked = false;
  });

  if (condFormat) {
    condFormat.disabled = !tableStyle;
    if (!tableStyle) condFormat.checked = false;
  }

  if (execBlock) {
    execBlock.style.display = tableStyle ? "none" : "block";
  }
}

function handleOptionalCheckboxChange() {
  const tableStyle = document.getElementById("includeTableFormats");
  const condFormat = document.getElementById("includeCondFormats");
  const optionalCheckboxes = getOptionalCheckboxes();
  const anyChecked = optionalCheckboxes.some(cb => cb.checked);

  if (anyChecked) {
    tableStyle.checked = false;
    tableStyle.disabled = true;
    if (condFormat) {
      condFormat.checked = false;
      condFormat.disabled = true;
    }
  } else {
    tableStyle.disabled = false;
    if (condFormat) {
      condFormat.disabled = !tableStyle.checked;
    }
  }
}

function filterDropdown(input) {
  const filter = input.value.toLowerCase();
  const group = input.closest('.ss-search-group');
  const select = group.querySelector('select');
  let visible = 0;

  Array.from(select.options).forEach(opt => {
    if (!opt.value) return;
    const match = opt.text.toLowerCase().includes(filter);
    opt.style.display = match ? '' : 'none';
    if (match) visible++;
  });

  select.size = Math.min(Math.max(visible, 2), 8);
}

function toggleInputMode(btn) {
  const container = btn.closest('div').querySelector('.ss-input-container');
  if (!container) return;

  const searchGroup = container.querySelector('.ss-search-group');
  const manualInput = container.querySelector('.ss-manual-id');
  const icon = btn.querySelector('i');
  const showingManual = manualInput.classList.contains('hidden');

  if (showingManual) {
    manualInput.classList.remove('hidden');
    if (searchGroup) searchGroup.classList.add('hidden');
    if (icon) icon.innerText = 'list';
    btn.style.background = '#e8f0fe';
    btn.title = "Switch to Dropdown Mode";
  } else {
    manualInput.classList.add('hidden');
    if (searchGroup) searchGroup.classList.remove('hidden');
    if (icon) icon.innerText = 'link';
    btn.style.background = '#f1f3f4';
    btn.title = "Switch to URL/ID Mode";
  }
}

function initLoad() {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) overlay.style.display = 'flex';

  google.script.run
    .withSuccessHandler(function(res) {
      if (overlay) overlay.style.display = 'none';
      if (!res || !res.files) {
        setStatus("No spreadsheet data returned", "error");
        return;
      }
      ssCache = res.files;

      document.querySelectorAll('.ss-select').forEach(select => {
        const placeholder = select.dataset.placeholder || "Select Spreadsheet...";
        let html = `<option value="" selected disabled>${placeholder}</option>`;
        html += ssCache.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
        select.innerHTML = html;
      });

      addVstackSource();
      setStatus("Ready", "success");
    })
    .withFailureHandler(err => {
      if (overlay) overlay.style.display = 'none';
      setStatus(err.message || String(err), "error");
    })
    .getInitialData();
  
  handleUI();
}

function setStatus(msg, type) {
  const statusEl = document.getElementById('status-msg');
  if (!statusEl) return;

  if (statusTimer) {
    clearTimeout(statusTimer);
    statusTimer = null;
  }

  statusEl.textContent = msg;
  statusEl.className = 'status-msg status-' + type;
  statusEl.style.display = 'block';

  statusTimer = setTimeout(() => {
    statusEl.style.display = 'none';
  }, 5000);
}

function handleUI() {
  const isTabular = document.getElementById('includeTableFormats')?.checked;
  const destControls = document.getElementById('dest-controls');

  if (destControls) {
    destControls.style.pointerEvents = isTabular ? 'none' : 'auto';
    destControls.style.opacity = isTabular ? '0.5' : '1';
  }

  const modeEl = document.querySelector('input[name="mode"]:checked');
  const execEl = document.querySelector('input[name="exec"]:checked');
  if (!modeEl || !execEl) return;

  const mode = modeEl.value;
  const exec = execEl.value;

  const batchWrap = document.getElementById('batch-wrap');
  if (batchWrap) batchWrap.classList.toggle('hidden', exec !== 'batch');

  const addBtn = document.getElementById('add-vstack-btn');
  if (addBtn) addBtn.classList.toggle('hidden', mode !== 'vstack');

  const advancedCheckboxes = ['includeHeaders', 'chkTimestamp', 'includeFormatting', 'includeHeaderFormats', 'includeCondFormats', 'includeFormulas'];
  advancedCheckboxes.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.disabled = isTabular;
    el.parentElement.style.opacity = isTabular ? "0.5" : "1";
    el.parentElement.style.pointerEvents = isTabular ? "none" : "auto";
  });

  if (isTabular) {
    document.querySelector('input[name="mode"][value="copy"]').checked = true;
    document.querySelector('input[name="exec"][value="std"]').checked = true;
    const dataMode = document.getElementById('dataMode');
    if (dataMode) dataMode.value = 'replace';
  }

  const saveBtn = document.querySelector('.btn-save');
  if (saveBtn) {
    if (editingIndex !== null) {
      saveBtn.innerHTML = '<i class="material-icons">update</i> Update Config';
      saveBtn.classList.remove('hidden');
      saveBtn.style.display = 'block';
    } else {
      saveBtn.innerHTML = '<i class="material-icons">save</i> Save Config';
    }
  }
}

function switchTab(tabId) {
  document.getElementById('view-new').classList.add('hidden');
  document.getElementById('view-saved').classList.add('hidden');

  const targetEl = document.getElementById('view-' + tabId);
  if (targetEl) {
    targetEl.classList.remove('hidden');
    if (tabId === 'saved') loadSaved();
  }

  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  const activeTab = document.getElementById('t-' + tabId);
  if (activeTab) activeTab.classList.add('active');
}

// ==================== DATA FETCHING ====================
function fetchSheets(el) {
  return new Promise((resolve) => {
    let ssId = el.value.trim();
    
    if (ssId.includes("docs.google.com/spreadsheets/d/")) {
      ssId = ssId.split("/d/")[1].split("/")[0];
      el.value = ssId;
    }
    
    const block = el.closest('.source-block') || el.closest('.card');
    const sheetSelect = block.querySelector('.sheet-select') || document.getElementById('destSheet');
    
    if (!ssId) return resolve();

    if (sheetSelect) {
      sheetSelect.innerHTML = '<option>Loading sheets...</option>';
      sheetSelect.disabled = true;
    }

    google.script.run
      .withSuccessHandler(sheets => {
        if (sheetSelect) {
          let optionsHtml = "";
          for (let i = 0; i < sheets.length; i++) {
            optionsHtml += '<option value="' + sheets[i] + '">' + sheets[i] + '</option>';
          }
          sheetSelect.innerHTML = optionsHtml;
          sheetSelect.disabled = false;
        }
        resolve(sheets);
      })
      .withFailureHandler(err => {
        if (sheetSelect) {
          sheetSelect.innerHTML = '<option>Error loading sheets</option>';
          sheetSelect.disabled = false;
        }
        console.error("Fetch Sheets Error: ", err);
        resolve([]);
      })
      .getSheetsInSpreadsheet(ssId);
  });
}

function fetchHeaders(el) {
  return new Promise((resolve) => {
    const block = el.closest('.source-block');
    const manualInput = block.querySelector('.ss-manual-id');
    const ssSelect = block.querySelector('.ss-select');
    const sheetSelect = block.querySelector('.sheet-select');
    const headerRowInput = block.querySelector('.src-header');
    const chipsContainer = block.querySelector('.column-chips-container');
    const fetchBtn = block.querySelector('.btn-small');

    let ssId = (!manualInput.classList.contains('hidden') && manualInput.value) 
               ? manualInput.value.trim() 
               : ssSelect.value;

    if (ssId.includes("/d/")) {
      ssId = ssId.split("/d/")[1].split("/")[0];
    }

    const sheetName = sheetSelect.value;
    const headerRow = (headerRowInput && headerRowInput.value) ? headerRowInput.value : 1;

    if (!ssId || !sheetName || sheetName === "Loading...") {
      setStatus("Select Spreadsheet and Sheet first", "error");
      return resolve([]);
    }

    if (fetchBtn) {
      fetchBtn.innerText = "Fetching...";
      fetchBtn.disabled = true;
    }
    chipsContainer.innerHTML = '<div style="font-size:11px; color:var(--blue); padding:5px;">Reading row ' + headerRow + '...</div>';

    google.script.run
      .withSuccessHandler(function(headers) {
        headerList = headers;

        if (fetchBtn) {
          fetchBtn.innerText = "Fetch Columns";
          fetchBtn.disabled = false;
        }
        
        chipsContainer.innerHTML = ''; 

        if (!headers || headers.length === 0) {
          chipsContainer.innerHTML = '<div style="color:var(--red); font-size:11px;">No headers found on row ' + headerRow + '</div>';
          return resolve([]);
        }

        headers.forEach(h => {
          if (!h) return;
          const chip = document.createElement('div');
          chip.className = 'chip active';
          chip.innerHTML = `<span>${h}</span><span style="margin-left:8px; font-weight:bold;">&times;</span>`;
          chip.onclick = function() { this.remove(); };
          chipsContainer.appendChild(chip);
        });

        const existingFilters = document.querySelectorAll('.f-col');
        existingFilters.forEach(select => {
          const currentVal = select.value;
          select.innerHTML = headers.map(h => `<option value="${h}">${h}</option>`).join('');
          if (headers.includes(currentVal)) select.value = currentVal;
        });

        resolve(headers);
      })
      .withFailureHandler(function(err) {
        if (fetchBtn) {
          fetchBtn.innerText = "Fetch Columns";
          fetchBtn.disabled = false;
        }
        chipsContainer.innerHTML = '<div style="color:var(--red); font-size:11px;">Error: ' + err + '</div>';
        resolve([]);
      })
      .getSheetColumns(ssId, sheetName, headerRow);
  });
}

// ==================== SOURCE MANAGEMENT ====================
function addVstackSource() {
  const container = document.getElementById('source-list');
  if (!container) return;

  const files = (typeof ssCache !== 'undefined' && Array.isArray(ssCache)) ? ssCache : [];
  const mode = document.querySelector('input[name="mode"]:checked')?.value;
  const isVstack = mode === 'vstack';
  const isFirstSource = container.children.length === 0;

  const newSource = document.createElement('div');
  newSource.className = 'source-block';
  newSource.dataset.mode = 'vstack';
  newSource.style = "border-top: 2px solid var(--blue); margin-top: 15px; padding-top: 10px; position: relative;";

  let ssOptions = '<option value="" disabled selected>Select Source Spreadsheet...</option>';
  for (let i = 0; i < files.length; i++) {
    ssOptions += `<option value="${files[i].id}">${files[i].name}</option>`;
  }

  newSource.innerHTML = `
    ${isVstack && !isFirstSource ? `
      <i class="material-icons cancel-source"
         style="position:absolute; right:0; top:5px; color:var(--red); cursor:pointer; font-size:18px;">
        cancel
      </i>
    ` : ``}

    <label>Source Spreadsheet</label>
    <div style="display: flex; gap: 4px; align-items: flex-start; margin-top: 4px;">
      <div class="ss-input-container" style="flex:1;">
        <div class="ss-search-group">
          <input type="text" class="ss-search-input" placeholder="üîç Search..." onkeyup="filterDropdown(this)">
          <select class="ss-select">${ssOptions}</select>
        </div>
        <input type="text" class="ss-manual-id hidden" placeholder="Paste URL or ID...">
      </div>
      <button type="button" class="toggle-btn" onclick="toggleInputMode(this)">
        <i class="material-icons" style="font-size:20px; color:#5f6368;">list</i>
      </button>
    </div>

    <label>Source Sheet</label>
    <select class="sheet-select" disabled>
      <option>Select spreadsheet first...</option>
    </select>

    <div class="src-extras">
      <label>Source Range</label>
      <input type="text" class="src-range" placeholder="A1:Z100">

      <div style="display: flex; align-items: flex-end; gap: 8px; margin-top: 12px;">
        <div style="flex: 1;">
          <label style="margin-top:0">Header Row</label>
          <input type="number" class="src-header" value="1" min="1">
        </div>
        <button type="button" class="btn-small">Fetch Columns</button>
      </div>

      <label style="margin-top:10px;">Columns to Include (click √ó to remove)</label>
      <div class="column-chips-container"
        style="display:flex; flex-wrap:wrap; gap:4px; margin-top:8px; border:1px solid #ddd; padding:8px; min-height:40px; border-radius:4px;">
      </div>
    </div>
  `;

  container.appendChild(newSource);

  const cancelBtn = newSource.querySelector('.cancel-source');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', () => { newSource.remove(); });
  }

  const ssSelect = newSource.querySelector('.ss-select');
  const manualInput = newSource.querySelector('.ss-manual-id');
  const sheetSelect = newSource.querySelector('.sheet-select');
  const fetchBtn = newSource.querySelector('.btn-small');

  const handleSSChange = (el) => {
    sheetSelect.disabled = true;
    sheetSelect.innerHTML = '<option>Loading sheets...</option>';
    fetchSheets(el).then(() => { sheetSelect.disabled = false; });
  };

  ssSelect.addEventListener('change', () => handleSSChange(ssSelect));
  manualInput.addEventListener('change', () => handleSSChange(manualInput));
  sheetSelect.addEventListener('change', () => {
    if (sheetSelect.value) fetchHeaders(fetchBtn);
  });
  fetchBtn.addEventListener('click', () => fetchHeaders(fetchBtn));
}

// ==================== FILTER MANAGEMENT ====================
function addFilterRow() {
  const container = document.getElementById('filter-rows');
  if (!container) return;

  const div = document.createElement('div');
  div.className = 'filter-row-item';
  div.style = "display:flex; gap:5px; margin-top:8px; align-items:center; background:#f1f3f4; padding:5px; border-radius:4px;";
  
  let hOpts = '<option value="">Select Column</option>';
  if (typeof headerList !== 'undefined' && headerList.length > 0) {
    for (let i = 0; i < headerList.length; i++) {
      hOpts += '<option value="' + headerList[i] + '">' + headerList[i] + '</option>';
    }
  }

  div.innerHTML = `
    <select class="f-col" style="flex:1;">${hOpts}</select>
    <select class="f-cond" style="flex:1;" onchange="toggleFilterValueInput(this)">
      <optgroup label="Text">
        <option value="equals">Equals</option>
        <option value="contains">Contains</option>
      </optgroup>
      <optgroup label="Number">
        <option value="greater_than">Greater Than</option>
        <option value="less_than">Less Than</option>
      </optgroup>
      <optgroup label="Logic">
        <option value="is_empty">Is Empty</option>
        <option value="is_not_empty">Is Not Empty</option>
      </optgroup>
      <optgroup label="Dates">
        <option value="today">Today</option>
        <option value="yesterday">Yesterday</option>
        <option value="last_n_days">Last N Days</option>
        <option value="next_n_days">Next N Days</option>
      </optgroup>
    </select>
    <input type="text" class="f-val" placeholder="Value" style="flex:0.8;">
    <i class="material-icons" style="color:var(--red); cursor:pointer; font-size:18px;" onclick="this.parentElement.remove()">remove_circle</i>
  `;
  
  container.appendChild(div);
}

function toggleFilterValueInput(selectEl) {
  // Handle both transfer filters (.f-val) and archive filters (.af-val)
  const valInput = selectEl.parentElement.querySelector('.f-val') || 
                    selectEl.parentElement.querySelector('.af-val');
  if (!valInput) return;
  
  const op = selectEl.value;
  const hideValue = ['is_empty', 'is_not_empty', 'today', 'yesterday', 'tomorrow'].includes(op);
  valInput.style.display = hideValue ? 'none' : 'block';
  if (op.includes('_n_')) valInput.placeholder = "Enter number (N)";
}

// ==================== CONFIG MANAGEMENT ====================
function gatherConfigFromUI() {
  try {
    const config = {};
    
    // Check if Archive mode is active
    const isArchiveMode = document.getElementById('archiveToggle')?.checked;
    
    if (isArchiveMode) {
      // ARCHIVE MODE CONFIG
      config.mode = 'archive';
      
      // Get source ID from either dropdown or manual input
      const manualInput = document.getElementById('archiveSourceFile-manual');
      const dropdown = document.getElementById('archiveSourceFile');
      
      let sourceId = '';
      let sourceName = '';
      
      if (manualInput && !manualInput.classList.contains('hidden') && manualInput.value) {
        sourceId = manualInput.value.trim();
        sourceName = manualInput.dataset.ssName || 'Spreadsheet';
      } else {
        sourceId = dropdown.value;
        sourceName = dropdown.selectedOptions[0]?.text || '';
      }
      
      config.archive = {
        sourceType: document.getElementById('archiveSourceType').value,
        sourceId: sourceId,
        sourceName: sourceName,
        cleanup: document.getElementById('archiveCleanup')?.checked || false,
        fileName: document.getElementById('archiveFileName')?.value || '',
        destinationMode: document.querySelector('input[name="archiveDest"]:checked')?.value || 'root'
      };
      
      // Get selected sheets if specific sheets mode
      if (config.archive.sourceType === 'sheet') {
        const sheetSelect = document.getElementById('archiveSheets');
        config.archive.sheets = Array.from(sheetSelect.selectedOptions).map(opt => opt.value);
      }
      
      // Get folder ID based on destination mode
      if (config.archive.destinationMode === 'select') {
        config.archive.folderId = document.getElementById('archive-folder-select')?.dataset?.folderId || '';
        config.archive.folderName = document.getElementById('archive-folder-select')?.dataset?.folderName || '';
      } else if (config.archive.destinationMode === 'paste') {
        config.archive.folderId = document.getElementById('archiveFolderPaste')?.value || '';
      }
      
      // Include Copy/Cut mode for Archive
      const archiveMode = document.querySelector('input[name="mode"]:checked')?.value || 'copy';
      config.archiveMode = archiveMode;
      
      // Gather archive filters
      let archiveFilters = [];
      document.querySelectorAll('#archive-filter-rows .filter-row-item').forEach(row => {
        const sheetSelect = row.querySelector('.af-sheet');
        const colSelect = row.querySelector('.af-col');
        const condSelect = row.querySelector('.af-cond');
        const valInput = row.querySelector('.af-val');
        
        const parentLabel = condSelect.options[condSelect.selectedIndex]?.parentElement?.label;
        const isDate = parentLabel === "Dates";
        
        archiveFilters.push({
          sheet: sheetSelect?.value || "",
          column: colSelect?.value || "",
          operator: condSelect?.value || "",
          value: valInput?.value || "",
          type: isDate ? 'date' : 'text'
        });
      });
      
      config.archive.filters = archiveFilters;
      
      return config;
    }
    
    // TRANSFER MODE CONFIG (existing logic)
    const getRadioValue = (name, fallback) => {
      const el = document.querySelector(`input[name="${name}"]:checked`);
      return el ? el.value : fallback;
    };

    const mode = getRadioValue("mode", "copy");
    const execType = getRadioValue("exec", "std");

    let sourceConfigs = [];
    document.querySelectorAll('.source-block').forEach(block => {
      const manual = block.querySelector('.ss-manual-id');
      const dropdown = block.querySelector('.ss-select');
      const inputMode = manual && !manual.classList.contains('hidden') ? 'manual' : 'dropdown';
      const srcSS = inputMode === 'manual' ? manual.value.trim() : dropdown.value;
      const chips = Array.from(block.querySelectorAll('.chip.active span:first-child')).map(s => s.innerText.trim());
      const rawHeader = block.querySelector('.src-header')?.value;

      sourceConfigs.push({
        inputMode: inputMode,
        srcSS: srcSS,
        srcSheet: block.querySelector('.sheet-select')?.value || "",
        srcRange: block.querySelector('.src-range')?.value || "",
        headerRow: (!rawHeader || rawHeader === "") ? 1 : parseInt(rawHeader),
        includedColumns: chips
      });
    });

    let filterConfigs = [];
    document.querySelectorAll('.filter-row-item').forEach(row => {
      const condSelect = row.querySelector('.f-cond');
      const parentLabel = condSelect.options[condSelect.selectedIndex].parentElement.label;
      const isDate = parentLabel === "Dates" || parentLabel === "Date Filters";

      filterConfigs.push({
        column: row.querySelector('.f-col')?.value || "",
        operator: condSelect.value || "",
        value: row.querySelector('.f-val')?.value || "",
        type: isDate ? 'date' : 'text'
      });
    });

    const destManual = document.getElementById('destSS-manual');
    const destSelect = document.getElementById('destSS');
    const destInputMode = destManual && !destManual.classList.contains('hidden') ? 'manual' : 'dropdown';
    const destSS = destInputMode === 'manual' && destManual.value ? destManual.value.trim() : (destSelect ? destSelect.value : "");

    config.mode = mode;
    config.exec = execType;
    config.batchSize = parseInt(document.getElementById('batchSize')?.value || 100);
    config.dataMode = document.getElementById('dataMode')?.value || 'replace';
    config.includeHeaders = document.getElementById('includeHeaders')?.checked || false;
    config.addTimestamp = document.getElementById('chkTimestamp')?.checked || false;
    config.includeFormulas = document.getElementById('includeFormulas')?.checked || false;
    config.includeFormatting = document.getElementById('includeFormatting')?.checked || false;
    config.includeHeaderFormats = document.getElementById('includeHeaderFormats')?.checked || false;
    config.includeCondFormats = document.getElementById('includeCondFormats')?.checked || false;
    config.includeTableFormats = document.getElementById('includeTableFormats')?.checked || false;
    config.destInputMode = destInputMode;
    config.destSS = destSS;
    config.destSheet = document.getElementById('destSheet')?.value || "";
    config.destStart = document.getElementById('destStart')?.value || 'A1';
    config.sources = sourceConfigs;
    config.filters = filterConfigs;

    return config;
  } catch (err) {
    console.error("Gathering Error:", err);
    return null;
  }
}

function runMigrationUI() {
  const finalConfig = gatherConfigFromUI();
  if (!finalConfig) {
    setStatus("Error gathering configuration", "error");
    return;
  }
  
  const isArchive = finalConfig.mode === 'archive';
  
  if (isArchive) {
    console.log('Archive Config:', JSON.stringify(finalConfig, null, 2)); // Debug log
    
    setStatus('Creating archive...', 'loading');
    
    google.script.run
      .withSuccessHandler(res => {
        if (res.status === 'success') {
          // Show clickable link in status
          if (res.fileUrl) {
            const statusDiv = document.getElementById('status-msg');
            if (statusDiv) {
              statusDiv.innerHTML = `
                ‚úì ${res.message}<br>
                <div style="margin-top:8px; padding:8px; background:#e8f5e9; border-radius:4px; border:1px solid #81c784;">
                  <span style="color:#2e7d32; font-weight:500;">üìÅ Your file is ready here:</span><br>
                  <a href="${res.fileUrl}" target="_blank" style="color:#1a73e8; text-decoration:none; font-size:12px; word-break:break-all;">
                    ${res.fileUrl}
                  </a>
                </div>
              `;
              statusDiv.className = 'status-success';
              statusDiv.style.display = 'block';
            }
          } else {
            setStatus(res.message, 'success');
          }
        } else {
          setStatus(res.message, 'error');
        }
      })
      .withFailureHandler(err => {
        console.error('Archive error:', err);
        setStatus("Archive failed: " + err, "error");
      })
      .runExecution(finalConfig);
  } else {
    const execType = finalConfig.exec || 'std';
    let execLabel = '';
    
    if (execType === 'row') {
      execLabel = 'Row-by-Row';
    } else if (execType === 'batch') {
      execLabel = 'Batch (' + (finalConfig.batchSize || 100) + ' rows)';
    } else {
      execLabel = 'Standard';
    }
    
    setStatus('Executing ' + execLabel + ' migration...', 'loading');
    
    google.script.run
      .withSuccessHandler(res => {
        setStatus(res.message, res.status);
      })
      .withFailureHandler(err => {
        setStatus("Migration failed: " + err, "error");
      })
      .runExecution(finalConfig);
  }
}

function saveConfigs() {
  const config = gatherConfigFromUI();
  if (!config) return;

  const isArchive = config.mode === 'archive';
  let configName = '';
  
  if (isArchive) {
    // ARCHIVE MODE VALIDATION & NAMING
    const arc = config.archive;
    
    if (!arc || !arc.sourceId) {
      setStatus("Please select a source spreadsheet to archive.", "error");
      return;
    }
    
    // Build default name for archive
    let defaultName = '';
    if (arc.sourceType === 'sheet' && arc.sheets && arc.sheets.length > 0) {
      const sheetNames = arc.sheets.slice(0, 2).join(', ');
      const more = arc.sheets.length > 2 ? ` +${arc.sheets.length - 2} more` : '';
      defaultName = `Archive: ${arc.sourceName} (${sheetNames}${more})`;
    } else {
      defaultName = `Archive: ${arc.sourceName}`;
    }
    
    // Add destination info
    if (arc.destinationMode === 'select' && arc.folderName) {
      defaultName += ` ‚Üí ${arc.folderName}`;
    } else if (arc.destinationMode === 'paste' && arc.folderId) {
      defaultName += ` ‚Üí Folder`;
    } else {
      defaultName += ` ‚Üí My Drive`;
    }
    
    configName = prompt("Enter configuration name:", defaultName);
    
  } else {
    // TRANSFER MODE VALIDATION & NAMING
    const firstBlock = document.querySelector('.source-block');
    if (!firstBlock) {
      setStatus("Please add a source.", "error");
      return;
    }
    
    const manualSrc = firstBlock.querySelector('.ss-manual-id');
    const ssSelect = firstBlock.querySelector('.ss-select');
    const destSSSelect = document.getElementById('destSS');
    const destManual = document.getElementById('destSS-manual');
    const sheetSelect = firstBlock.querySelector('.sheet-select');
    const destSheetSelect = document.getElementById('destSheet');
    
    const srcVal = (!manualSrc.classList.contains('hidden') && manualSrc.value) ? manualSrc.value.trim() : ssSelect.value;
    const destVal = (!destManual.classList.contains('hidden') && destManual.value) ? destManual.value.trim() : destSSSelect.value;

    if (!srcVal || !destVal) {
      setStatus("Please select/enter Source and Destination.", "error");
      return;
    }

    const srcName = (!manualSrc.classList.contains('hidden')) ? (manualSrc.dataset.ssName || 'Source Spreadsheet') : ssSelect.options[ssSelect.selectedIndex].text;
    const destName = (!destManual.classList.contains('hidden')) ? (destManual.dataset.ssName || 'Destination Spreadsheet') : destSSSelect.options[destSSSelect.selectedIndex].text;
    const srcTab = sheetSelect.value || "Sheet1";
    const destTab = destSheetSelect.value || "Sheet1";
    const defaultName = `${srcName} (${srcTab}) ‚Üí ${destName} (${destTab})`;
    configName = prompt("Enter configuration name:", defaultName);
    
    if (configName) {
      config.srcSSName = srcName;
      config.destSSName = destName;
      config.srcSheet = srcTab;
      config.destSheet = destTab;
    }
  }
  
  if (!configName) return;

  config.name = configName;

  setStatus("Saving...", "success");

  google.script.run.withSuccessHandler(res => {
    setStatus(res.message || "Saved successfully", "success");
    if (res.status === 'success') {
      resetNewConfigForm();
      loadSaved();
      switchTab('saved');
    }
  }).withFailureHandler(err => {
    setStatus("Save failed: " + err, "error");
  }).saveConfiguration(config, editingIndex);
}

function handleSaveOrUpdate() {
  const config = gatherConfigFromUI();
  if (!config) return;

  const overlay = document.getElementById('loading-overlay');
  if (overlay) overlay.style.display = 'flex';
  
  setStatus("Saving...", "success");

  google.script.run
    .withSuccessHandler(res => {
      if (overlay) overlay.style.display = 'none';
      if (res.status === 'success') {
        setStatus(res.message, "success");
        resetNewConfigForm();
        loadSaved();
        switchTab('saved');
      } else {
        setStatus(res.message, "error");
      }
    })
    .withFailureHandler(err => {
      if (overlay) overlay.style.display = 'none';
      setStatus("Error: " + err, "error");
    })
    .saveConfiguration(config, editingIndex);
}

// ==================== SAVED CONFIGS ====================
function loadSaved() {
  const container = document.getElementById('saved-list');
  const filterVal = document.getElementById('filterSchedule')?.value || 'all';
  const onlyThisSpreadsheet = document.getElementById('filterCurrentSheet')?.checked;
  const onlyArchives = document.getElementById('filterArchiveOnly')?.checked;

  if (!container) return;
  container.innerHTML = '<div style="padding:20px; text-align:center;">Loading...</div>';

  google.script.run.withSuccessHandler(function(context) {
    const currentSSId = context?.spreadsheetId || '';

    google.script.run.withSuccessHandler(function(configs) {
      container.innerHTML = '';

      if (!configs || configs.length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">No saved configs found.</div>';
        return;
      }

      configs.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));

      const filtered = configs.filter(c => {
        // Filter by schedule status
        const isActive = !!c.triggerActive;
        if (filterVal === 'scheduled' && !isActive) return false;
        if (filterVal === 'not-scheduled' && isActive) return false;

        // Filter by Archive mode
        if (onlyArchives) {
          if (c.mode !== 'archive') return false;
        }

        // Filter by current spreadsheet
        if (onlyThisSpreadsheet) {
          // Archive configs don't have destSS in the same way
          if (c.mode === 'archive') {
            // For archives, check source spreadsheet
            if (!c.archive || !c.archive.sourceId) return false;
            let sourceId = c.archive.sourceId;
            if (sourceId.includes('/d/')) {
              sourceId = sourceId.split('/d/')[1].split('/')[0];
            }
            if (sourceId !== currentSSId) return false;
          } else {
            // For transfers, check destination spreadsheet
            if (!c.destSS || !currentSSId) return false;
            let destId = c.destSS;
            if (destId.includes('/d/')) {
              destId = destId.split('/d/')[1].split('/')[0];
            }
            if (destId !== currentSSId) return false;
          }
        }

        return true;
      });

      if (filtered.length === 0) {
        const msg = onlyArchives 
          ? 'No archive configs found.'
          : onlyThisSpreadsheet 
            ? 'No configs for this spreadsheet.'
            : 'No configs match the selected filters.';
        container.innerHTML = `<div style="padding:20px; text-align:center; color:#666;">${msg}</div>`;
        return;
      }

      filtered.forEach(c => {
        const isActive = !!c.triggerActive;
        const hasMenu = !!c.hasMenu;
        const isArchive = c.mode === 'archive';

        const div = document.createElement('div');
        div.className = 'card';
        
        // Build config info based on type
        let configIcon = isArchive ? 'üóÑÔ∏è' : 'üìä';
        let configInfo = '';
        let dateInfo = '';
        
        if (isArchive) {
          const arc = c.archive || {};
          // FIX #7: Read sheets from arc.sheets array, not arc.sourceType
          const sheetCount = (arc.sourceType === 'sheet' && arc.sheets && arc.sheets.length) 
            ? arc.sheets.length 
            : 0;
          const sheetText = sheetCount > 0 
            ? `${sheetCount} sheet(s)` 
            : 'Entire file';
          
          configInfo = `
            <div style="font-size:10px; color:#666; margin-top:4px;">
              ${sheetText} ‚Üí ${arc.folderName || 'My Drive'}
            </div>
          `;
          // Show lastRun for archives
          dateInfo = c.lastRun 
            ? `Last run: ${new Date(c.lastRun).toLocaleString()}` 
            : `Created: ${c.timestamp ? new Date(c.timestamp).toLocaleString() : 'N/A'}`;
        } else {
          configInfo = `
            <div style="font-size:10px; color:#666; margin-top:4px;">
              Mode: ${c.mode || 'copy'} | Exec: ${c.exec || 'std'}
            </div>
          `;
          dateInfo = `Modified: ${c.timestamp ? new Date(c.timestamp).toLocaleString() : 'N/A'}`;
        }
        
        // FIX #8: Make archive name clickable
        const nameClickHandler = isArchive 
          ? `onclick="openArchiveFolder('${c.id}')" style="cursor:pointer;"` 
          : '';
        
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
            <div style="flex:1;">
              <div style="font-weight:bold; color:${isArchive ? '#2e7d32' : 'var(--blue)'}; font-size:13px; line-height:1.2; display:flex; align-items:center; gap:4px;">
                <span ${nameClickHandler}>${configIcon} ${c.name}</span>
                ${isArchive ? '<i class="material-icons" style="font-size:14px; color:#666; cursor:pointer;" onclick="openArchiveFolder(\'' + c.id + '\')">link</i>' : ''}
              </div>
              ${configInfo}
              <div style="font-size:9px; color:#999; margin-top:2px;">
                ${dateInfo}
              </div>
            </div>
            ${isActive ? '<span class="status-pill pill-active" style="font-size:9px;">‚óè Scheduled</span>' : ''}
          </div>

          <div class="tool-btn-row" style="display:flex; gap:5px; align-items:center; justify-content:flex-end;">
            <div style="position:relative;">
              <button class="tool-btn" title="More options" style="background:#5f6368" onclick="toggleConfigMenu('${c.id}')">
                <i class="material-icons">more_vert</i>
              </button>
              <div id="menu-${c.id}" class="config-menu hidden">
                <div class="menu-item" onclick="runSavedConfigById('${c.id}'); toggleConfigMenu('${c.id}')" style="color:#1e8e3e;">
                  <i class="material-icons" style="color:#1e8e3e;">play_arrow</i>
                  Run
                </div>
                ${isActive
                  ? `<div class="menu-item" onclick="stopTrigger('${c.id}'); toggleConfigMenu('${c.id}')" style="color:#673ab7;">
                       <i class="material-icons" style="color:#673ab7;">alarm_off</i>
                       Unschedule
                     </div>`
                  : `<div class="menu-item" onclick="openScheduler('${c.id}'); toggleConfigMenu('${c.id}')" style="color:#1a73e8;">
                       <i class="material-icons" style="color:#1a73e8;">calendar_today</i>
                       Schedule
                     </div>`}
                <div class="menu-item" onclick="toggleCustomMenu('${c.id}'); toggleConfigMenu('${c.id}')" style="color:#5f6368;">
                  <i class="material-icons" style="color:#5f6368;">${hasMenu ? 'speaker_notes_off' : 'menu_book'}</i>
                  ${hasMenu ? 'Remove from Menu' : 'Add to Menu'}
                </div>
                <div class="menu-item" onclick="editConfig('${c.id}'); toggleConfigMenu('${c.id}')" style="color:#f59e0b;">
                  <i class="material-icons" style="color:#f59e0b;">edit</i>
                  Edit
                </div>
                <div class="menu-item" onclick="exportConfigAsCode('${c.id}'); toggleConfigMenu('${c.id}')" style="color:#9c27b0;">
                  <i class="material-icons" style="color:#9c27b0;">code</i>
                  Export Code
                </div>
                <div class="menu-item" onclick="deleteCfg('${c.id}')" style="color:var(--red)">
                  <i class="material-icons" style="color:var(--red);">delete</i>
                  Delete
                </div>
              </div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }).getSavedConfigs();
  }).getActiveSheetContext();
}

function exportConfigAsCode(id) {
  setStatus("Generating script...", "loading");
  google.script.run.withSuccessHandler(code => {
    if (code.startsWith("Error")) {
      setStatus(code, "error");
      return;
    }
    navigator.clipboard.writeText(code);
    setStatus("Standalone script copied!", "success");
  }).exportConfigAsCodeById(id);
}

function runSavedConfigById(id) {
  setStatus("Loading config...", "loading");

  google.script.run
    .withSuccessHandler(config => {
      if (!config) {
        setStatus("Config not found", "error");
        return;
      }

      const isArchive = config.mode === 'archive';
      setStatus("Running: " + config.name, "loading");

      google.script.run
        .withSuccessHandler(res => {
          if (res.status === 'success') {
            setStatus(res.message || "Done", "success");
            
            // For archives, offer to open the file
            if (isArchive && res.fileUrl) {
              setTimeout(() => {
                if (confirm('Archive created! Open archived file?')) {
                  window.open(res.fileUrl, '_blank');
                }
              }, 500);
            }
          } else {
            setStatus(res.message, "error");
          }
        })
        .withFailureHandler(err => {
          setStatus("Execution failed: " + err, "error");
        })
        .runExecution(config);
    })
    .withFailureHandler(err => {
      setStatus("Failed to load config: " + err, "error");
    })
    .getConfigById(id);
}

function toggleConfigMenu(id) {
  const menu = document.getElementById('menu-' + id);
  if (!menu) return;
  
  // Close all other menus
  document.querySelectorAll('.config-menu').forEach(m => {
    if (m.id !== 'menu-' + id) {
      m.classList.add('hidden');
    }
  });
  
  // Toggle this menu
  menu.classList.toggle('hidden');
}

function openArchiveFolder(configId) {
  setStatus("Loading archive info...", "loading");
  
  google.script.run
    .withSuccessHandler(config => {
      if (!config || !config.archive) {
        setStatus("Archive config not found", "error");
        return;
      }
      
      const arc = config.archive;
      
      // Try to get the last archived file URL
      google.script.run
        .withSuccessHandler(fileUrl => {
          if (fileUrl) {
            window.open(fileUrl, '_blank');
            setStatus("Opened archived file", "success");
          } else {
            // Fallback to opening folder if no file URL available
            google.script.run
              .withSuccessHandler(folderUrl => {
                if (folderUrl) {
                  window.open(folderUrl, '_blank');
                  setStatus("Opened archive folder", "success");
                } else {
                  setStatus("No archived file found yet. Run the archive first.", "error");
                }
              })
              .withFailureHandler(err => {
                setStatus("Error: " + err, "error");
              })
              .getArchiveFolderUrl(arc.folderId, arc.destinationMode);
          }
        })
        .withFailureHandler(err => {
          setStatus("Error: " + err, "error");
        })
        .getLastArchivedFileUrl(configId);
    })
    .withFailureHandler(err => {
      setStatus("Error loading config: " + err, "error");
    })
    .getConfigById(configId);
}

function deleteCfg(id) {
  if (!confirm('Delete config?')) return;
  setStatus("Deleting config...", "loading");

  google.script.run
    .withSuccessHandler(res => {
      loadSaved();
      setStatus("Config deleted successfully", "success");
    })
    .withFailureHandler(err => {
      console.error(err);
      setStatus("Failed to delete config", "error");
    })
    .deleteConfigById(id);
}

function toggleConfigMenu(id) {
  const menu = document.getElementById('menu-' + id);
  if (!menu) return;
  
  // Close all other menus
  document.querySelectorAll('.config-menu').forEach(m => {
    if (m.id !== 'menu-' + id) {
      m.classList.add('hidden');
    }
  });
  
  // Toggle this menu
  menu.classList.toggle('hidden');
}

function openArchiveFolder(configId) {
  setStatus("Loading archive info...", "loading");
  
  google.script.run
    .withSuccessHandler(config => {
      if (!config || !config.archive) {
        setStatus("Archive config not found", "error");
        return;
      }
      
      const arc = config.archive;
      
      // Get folder URL
      google.script.run
        .withSuccessHandler(folderUrl => {
          if (folderUrl) {
            window.open(folderUrl, '_blank');
            setStatus("Opened archive folder", "success");
          } else {
            setStatus("No folder specified - archives in My Drive root", "error");
          }
        })
        .withFailureHandler(err => {
          setStatus("Error: " + err, "error");
        })
        .getArchiveFolderUrl(arc.folderId, arc.destinationMode);
    })
    .withFailureHandler(err => {
      setStatus("Error loading config: " + err, "error");
    })
    .getConfigById(configId);
}

function toggleCustomMenu(id) {
  setStatus("Updating menus...", "loading");

  google.script.run
    .withSuccessHandler(() => {
      loadSaved();
      setStatus("Menus updated!", "success");
    })
    .withFailureHandler(err => {
      console.error(err);
      setStatus("Failed to update menus", "error");
    })
    .toggleMenuFlagById(id);
}

// ==================== EDIT CONFIG ====================
function editConfig(id) {
  setStatus("Loading configuration...", "loading");
  editingIndex = id;

  google.script.run.withSuccessHandler(function(cfg) {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) overlay.style.display = 'none';

    if (!cfg) {
      setStatus("Error: Configuration not found.", "error");
      return;
    }
    
    switchTab('new');

    // HANDLE ARCHIVE MODE
    if (cfg.mode === 'archive') {
      document.getElementById('archiveToggle').checked = true;
      toggleArchiveMode();
      
      const arc = cfg.archive;
      
      // Set source type
      document.getElementById('archiveSourceType').value = arc.sourceType || 'file';
      handleArchiveSourceType();
      
      // Set source spreadsheet
      const dropdown = document.getElementById('archiveSourceFile');
      const manual = document.getElementById('archiveSourceFile-manual');
      
      if (arc.sourceId) {
        dropdown.value = arc.sourceId;
        loadArchiveSheets();
      }
      
      // Set selected sheets
      if (arc.sourceType === 'sheet' && arc.sheets) {
        setTimeout(() => {
          const sheetSelect = document.getElementById('archiveSheets');
          Array.from(sheetSelect.options).forEach(opt => {
            if (arc.sheets.includes(opt.value)) {
              opt.selected = true;
            }
          });
          updateArchiveNamePreview();
        }, 500);
      }
      
      // Set destination mode
      if (arc.destinationMode) {
        document.querySelector(`input[name="archiveDest"][value="${arc.destinationMode}"]`).checked = true;
        handleArchiveDestChange();
      }
      
      // Set folder info
      if (arc.destinationMode === 'select' && arc.folderId) {
        applySelectedFolder(arc.folderId, arc.folderName || 'Selected Folder');
      } else if (arc.destinationMode === 'paste' && arc.folderId) {
        document.getElementById('archiveFolderPaste').value = arc.folderId;
      }
      
      // Set filename
      if (arc.fileName) {
        document.getElementById('archiveFileName').value = arc.fileName;
      }
      
      // Set cleanup option
      if (arc.cleanup) {
        document.getElementById('archiveCleanup').checked = true;
      }
      
      // Set archive filters
      if (arc.filters && arc.filters.length > 0) {
        arc.filters.forEach(filter => {
          addArchiveFilterRow();
          const rows = document.querySelectorAll('#archive-filter-rows .filter-row-item');
          const lastRow = rows[rows.length - 1];
          
          lastRow.querySelector('.af-sheet').value = filter.sheet;
          loadArchiveFilterColumns(lastRow.querySelector('.af-sheet'));
          
          setTimeout(() => {
            lastRow.querySelector('.af-col').value = filter.column;
            lastRow.querySelector('.af-cond').value = filter.operator;
            lastRow.querySelector('.af-val').value = filter.value;
            
            // Toggle value input visibility based on operator
            toggleFilterValueInput(lastRow.querySelector('.af-cond'));
          }, 300);
        });
      }
      
      // Set Copy/Cut mode
      if (cfg.archiveMode) {
        document.querySelector(`input[name="mode"][value="${cfg.archiveMode}"]`).checked = true;
      }
      
      toggleEditUI(true);
      setStatus("Ready to Update Archive Config", "success");
      return;
    }

    // HANDLE TRANSFER MODE (existing logic)
    document.querySelector(`input[name="mode"][value="${cfg.mode}"]`).checked = true;
    document.querySelector(`input[name="exec"][value="${cfg.exec}"]`).checked = true;
    
    const dataModeEl = document.getElementById('dataMode');
    const batchSizeEl = document.getElementById('batchSize');
    if (dataModeEl) dataModeEl.value = cfg.dataMode || 'replace';
    if (batchSizeEl) batchSizeEl.value = cfg.batchSize || 100;
    
    document.getElementById('includeHeaders').checked = !!cfg.includeHeaders;
    document.getElementById('chkTimestamp').checked = !!cfg.addTimestamp;
    document.getElementById('includeFormulas').checked = !!cfg.includeFormulas;
    document.getElementById('includeFormatting').checked = !!cfg.includeFormatting;
    document.getElementById('includeHeaderFormats').checked = !!cfg.includeHeaderFormats;
    document.getElementById('includeCondFormats').checked = !!cfg.includeCondFormats;
    document.getElementById('includeTableFormats').checked = !!cfg.includeTableFormats;

    const destSelect = document.getElementById('destSS');
    const destManual = document.getElementById('destSS-manual');
    const destSheetSelect = document.getElementById('destSheet');
    const destToggle = document.querySelector('#view-new .card:nth-of-type(2) .toggle-btn');

    if (cfg.destInputMode === 'manual') {
      destManual.value = cfg.destSS;
      destManual.classList.remove('hidden');
      destSelect.parentElement.classList.add('hidden');
      if (destToggle) destToggle.style.background = '#e8f0fe';
    } else {
      destSelect.value = cfg.destSS || 'current';
      destManual.classList.add('hidden');
      destSelect.parentElement.classList.remove('hidden');
      if (destToggle) destToggle.style.background = '#f1f3f4';
    }
    
    if (destSheetSelect) {
      destSheetSelect.innerHTML = `<option value="${cfg.destSheet}" selected>${cfg.destSheet}</option>`;
      destSheetSelect.disabled = false;
    }
    
    document.getElementById('destStart').value = cfg.destStart || "A1";

    const sourceList = document.getElementById('source-list');
    sourceList.innerHTML = '';

    if (cfg.sources && cfg.sources.length > 0) {
      cfg.sources.forEach((src) => {
        addVstackSource();
        
        const blocks = sourceList.getElementsByClassName('source-block');
        const currentBlock = blocks[blocks.length - 1];

        const srcSelect = currentBlock.querySelector('.ss-select');
        const srcManual = currentBlock.querySelector('.ss-manual-id');
        const srcToggle = currentBlock.querySelector('.toggle-btn');

        if (src.inputMode === 'manual') {
          srcManual.value = src.srcSS;
          srcManual.classList.remove('hidden');
          srcSelect.parentElement.classList.add('hidden');
          if (srcToggle) srcToggle.style.background = '#e8f0fe';
        } else {
          srcSelect.value = src.srcSS;
        }

        const sheetSelect = currentBlock.querySelector('.sheet-select');
        sheetSelect.innerHTML = `<option value="${src.srcSheet}" selected>${src.srcSheet}</option>`;
        sheetSelect.disabled = false;
        
        currentBlock.querySelector('.src-range').value = src.srcRange || "";
        currentBlock.querySelector('.src-header').value = src.headerRow || 1;

        const chipContainer = currentBlock.querySelector('.column-chips-container');
        chipContainer.innerHTML = '';
        if (src.includedColumns) {
          src.includedColumns.forEach(col => {
            const chip = document.createElement('div');
            chip.className = 'chip active';
            chip.innerHTML = `<span>${col}</span><span style="margin-left:8px; font-weight:bold;">&times;</span>`;
            chip.onclick = function() { this.remove(); };
            chipContainer.appendChild(chip);
          });
        }
      });
    }

    const filterContainer = document.getElementById('filter-rows');
    filterContainer.innerHTML = '';
    if (cfg.filters) {
      cfg.filters.forEach(f => {
        addFilterRow();
        const rows = filterContainer.getElementsByClassName('filter-row-item');
        const currentRow = rows[rows.length - 1];
        const colSelect = currentRow.querySelector('.f-col');

        if (typeof headerList !== 'undefined' && !headerList.includes(f.column)) {
          const opt = document.createElement('option');
          opt.value = f.column;
          opt.text = f.column;
          colSelect.add(opt);
        }

        colSelect.value = f.column;
        currentRow.querySelector('.f-cond').value = f.operator;
        currentRow.querySelector('.f-val').value = f.value;
        
        if (typeof toggleFilterValueInput === "function") {
          toggleFilterValueInput(currentRow.querySelector('.f-cond'));
        }
      });
    }

    toggleEditUI(true);
    handleUI();
    setStatus("Ready to Update", "success");
  }).getConfigById(id);
}

function toggleEditUI(isEditing) {
  const newActions = document.getElementById('new-actions-group');
  let editWrap = document.getElementById('edit-actions-wrap');
  
  if (isEditing) {
    if (newActions) newActions.style.display = 'none';

    if (!editWrap) {
      editWrap = document.createElement('div');
      editWrap.id = 'edit-actions-wrap';
      editWrap.style = "display:flex; flex-direction:column; gap:8px; margin-top:0;";
      editWrap.innerHTML = `
        <button type="button" class="btn" style="background:var(--green); width:100%;" onclick="runMigrationUI()">
          <i class="material-icons">play_arrow</i> Run Once
        </button>
        <div style="display:flex; gap:8px;">
          <button type="button" class="btn" style="background:var(--blue); flex:1;" onclick="handleSaveOrUpdate()">
            <i class="material-icons">update</i> Update Config
          </button>
          <button type="button" class="btn" style="background:#666; flex:1;" onclick="resetNewConfigForm()">
            <i class="material-icons">close</i> Cancel
          </button>
        </div>
      `;
      document.getElementById('main-footer-actions').appendChild(editWrap);
    }
    editWrap.style.display = 'flex';
  } else {
    if (newActions) newActions.style.display = 'flex';
    if (editWrap) editWrap.style.display = 'none';
    
    editingIndex = null;
    currentEditingName = "";
  }
}

function resetNewConfigForm() {
  editingIndex = null;
  currentEditingName = "";
  
  if (typeof toggleEditUI === "function") {
    toggleEditUI(false);
  }
  
  // Reset archive mode
  const archiveToggle = document.getElementById('archiveToggle');
  if (archiveToggle && archiveToggle.checked) {
    archiveToggle.checked = false;
    toggleArchiveMode();
  }
  
  // Clear archive-specific fields
  const archiveFilterRows = document.getElementById('archive-filter-rows');
  if (archiveFilterRows) archiveFilterRows.innerHTML = "";
  
  const archiveFileName = document.getElementById('archiveFileName');
  if (archiveFileName) archiveFileName.value = "";
  
  const selectedFolderName = document.getElementById('selected-folder-name');
  if (selectedFolderName) selectedFolderName.value = "";
  
  const archiveFolderPaste = document.getElementById('archiveFolderPaste');
  if (archiveFolderPaste) archiveFolderPaste.value = "";
  
  // Reset to default folder destination
  const rootRadio = document.querySelector('input[name="archiveDest"][value="root"]');
  if (rootRadio) rootRadio.checked = true;
  
  const sourceList = document.getElementById('source-list');
  const filterRows = document.getElementById('filter-rows');
  if (sourceList) sourceList.innerHTML = "";
  if (filterRows) filterRows.innerHTML = "";
  
  if (typeof addVstackSource === "function") {
    addVstackSource();
  }
  
  const destSS = document.getElementById('destSS');
  const destManual = document.getElementById('destSS-manual');
  if (destSS) {
    destSS.value = "current";
    destSS.parentElement.classList.remove('hidden');
  }
  if (destManual) {
    destManual.value = "";
    destManual.classList.add('hidden');
  }

  document.querySelectorAll('#view-new input:not([type="radio"]), #view-new select').forEach(el => {
    if (el.type === 'checkbox') {
      el.checked = false;
    } else if (el.id !== 'destSS') {
      el.value = "";
    }
  });

  if (document.getElementById('destStart')) document.getElementById('destStart').value = "A1";
  if (document.getElementById('batchSize')) document.getElementById('batchSize').value = "100";
  if (document.getElementById('dataMode')) document.getElementById('dataMode').value = "replace";

  if (typeof handleUI === "function") handleUI();
  
  setStatus("Form reset to default.", "success");
}

// ==================== SCHEDULER ====================
function openScheduler(configId) {
  const overlay = document.getElementById('modal-overlay');
  const content = document.getElementById('modal-content');
  overlay.classList.remove('hidden');
  
  let hourOptions = "";
  for (let i = 0; i < 24; i++) {
    let label = i === 0 ? "12 AM" : i === 12 ? "12 PM" : i < 12 ? i + " AM" : (i - 12) + " PM";
    hourOptions += '<option value="' + i + '">' + label + '</option>';
  }

  const days = ['S','M','T','W','T','F','S'];
  let dayCircles = "";
  for (let i = 0; i < days.length; i++) {
    dayCircles += '<div class="day-circle" data-val="' + i + '" onclick="this.classList.toggle(\'active-day\')">' + days[i] + '</div>';
  }

  content.innerHTML = `
    <h3 style="margin-top:0">Schedule Configuration</h3>
    <div class="recurrence-row" style="margin-bottom:15px;">
      <span>Repeat every</span>
      <input type="number" id="repeatEvery" value="1" style="width:50px;">
      <select id="repeatUnit" onchange="toggleExtraOptions(this.value)">
        <option value="minute">minutes</option>
        <option value="hour">hours</option>
        <option value="day" selected>days</option>
        <option value="week">weeks</option>
        <option value="month">months</option>
      </select>
    </div>

    <div id="timeSection" style="margin-bottom:15px;">
      <label>Start Time (Hour)</label>
      <select id="repeatHour" style="width:100%;">${hourOptions}</select>
    </div>

    <div id="monthSection" class="hidden" style="margin-bottom:15px;">
      <label>On Day of Month</label>
      <input type="number" id="monthDayNum" value="1" min="1" max="31" style="width:60px;">
    </div>

    <div id="weekSection" class="hidden" style="margin-bottom:15px;">
      <label>Repeat on</label>
      <div style="display:flex; gap:8px; margin-top:8px;">${dayCircles}</div>
    </div>

    <div style="margin-top:20px; padding:12px; background-color:var(--bg); border:1px solid var(--gray); border-radius:8px;">
      <label class="checkbox-label" style="display:flex; align-items:center; gap:8px; cursor:pointer;">
        <input type="checkbox" id="alertEmail" checked>
        <span style="font-weight:500; font-size:12px;">Email alert on failure</span>
      </label>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:25px;">
      <button type="button" onclick="closeModal()" class="btn-small">Cancel</button>
      <button type="button" onclick="saveComplexSchedule('${configId}')" class="btn-save" style="width:auto; padding:8px 20px;">Done</button>
    </div>
  `;
  
  if (typeof toggleExtraOptions === "function") toggleExtraOptions('day');
}

function toggleExtraOptions(val) {
  try {
    const weekSec = document.getElementById('weekSection');
    const monthSec = document.getElementById('monthSection');
    const timeSec = document.getElementById('timeSection');
    const repeatEvery = document.getElementById('repeatEvery');

    if (weekSec) {
      val === 'week' ? weekSec.classList.remove('hidden') : weekSec.classList.add('hidden');
    }
    
    if (monthSec) {
      val === 'month' ? monthSec.classList.remove('hidden') : monthSec.classList.add('hidden');
    }

    const isTimeHidden = (val === 'onEdit' || val === 'minute' || val === 'hour');
    if (timeSec) {
      isTimeHidden ? timeSec.classList.add('hidden') : timeSec.classList.remove('hidden');
    }

    if (repeatEvery && repeatEvery.parentElement) {
      val === 'onEdit' ? repeatEvery.parentElement.classList.add('hidden') : repeatEvery.parentElement.classList.remove('hidden');
    }
  } catch (e) {
    console.error("Schedule UI Toggle Error:", e);
  }
}

function saveComplexSchedule(configId) {
  try {
    const getVal = (id, fallback = null) => {
      const el = document.getElementById(id);
      return el ? el.value : fallback;
    };
    
    const unit = getVal('repeatUnit');
    const dayNum = parseInt(getVal('monthDayNum', 1));
    
    if (unit === 'month' && dayNum > 28) {
      const proceed = confirm("Note: Setting a trigger for the 29th, 30th, or 31st means it will NOT run in months that are shorter (like February). Proceed anyway?");
      if (!proceed) return;
    }

    const selectedDays = Array.from(document.querySelectorAll('.day-circle.active-day')).map(el => el.getAttribute('data-val'));
    const alertEmail = document.getElementById('alertEmail') ? document.getElementById('alertEmail').checked : false;

    const scheduleData = {
      unit: unit,
      every: parseInt(getVal('repeatEvery', 1)),
      hour: parseInt(getVal('repeatHour', 9)),
      dayNum: dayNum,
      days: selectedDays,
      alertEmail: alertEmail
    };

    setStatus("Setting trigger...", "loading");
    
    google.script.run
      .withSuccessHandler(res => {
        closeModal();
        setStatus(res, "success");
        loadSaved();
      })
      .withFailureHandler(err => {
        setStatus("Trigger Error: " + err, "error");
      })
      .createScheduleComplex(configId, scheduleData);
    
  } catch (e) {
    console.error("Schedule Save Error:", e);
    alert("Error: " + e.message);
  }
}

function stopTrigger(id) {
  if (!confirm("Stop this schedule?")) return;
  setStatus("Stopping...", "loading");

  google.script.run.withSuccessHandler(res => {
    setStatus(res.message, res.status);
    loadSaved();
  }).stopScheduleById(id);
}

function closeModal() {
  const overlay = document.getElementById('modal-overlay');
  if (overlay) overlay.classList.add('hidden');
}
  </script>
</body>
</html>